var t,e,s,i,n={};t=n,e="WebGL2",s=()=>g,Object.defineProperty(t,e,{get:s,set:i,enumerable:!0,configurable:!0});class o{constructor(t){this.data=t,this.mul=t=>{const e=this.data,s=t.data;return new o([s[0]*e[0]+s[1]*e[4]+s[2]*e[8]+s[3]*e[12],s[0]*e[1]+s[1]*e[5]+s[2]*e[9]+s[3]*e[13],s[0]*e[2]+s[1]*e[6]+s[2]*e[10]+s[3]*e[14],s[0]*e[3]+s[1]*e[7]+s[2]*e[11]+s[3]*e[15],s[4]*e[0]+s[5]*e[4]+s[6]*e[8]+s[7]*e[12],s[4]*e[1]+s[5]*e[5]+s[6]*e[9]+s[7]*e[13],s[4]*e[2]+s[5]*e[6]+s[6]*e[10]+s[7]*e[14],s[4]*e[3]+s[5]*e[7]+s[6]*e[11]+s[7]*e[15],s[8]*e[0]+s[9]*e[4]+s[10]*e[8]+s[11]*e[12],s[8]*e[1]+s[9]*e[5]+s[10]*e[9]+s[11]*e[13],s[8]*e[2]+s[9]*e[6]+s[10]*e[10]+s[11]*e[14],s[8]*e[3]+s[9]*e[7]+s[10]*e[11]+s[11]*e[15],s[12]*e[0]+s[13]*e[4]+s[14]*e[8]+s[15]*e[12],s[12]*e[1]+s[13]*e[5]+s[14]*e[9]+s[15]*e[13],s[12]*e[2]+s[13]*e[6]+s[14]*e[10]+s[15]*e[14],s[12]*e[3]+s[13]*e[7]+s[14]*e[11]+s[15]*e[15]])}}}class r{constructor(t){this.matrix=t}}class a{constructor(t){this.entity=t}}class c{constructor(t){this.vertices=t.vertices,this.indices=t.indices}}class h{constructor(t){this.x=t.x,this.y=t.y,this.z=t.z}matrix=()=>new o([1,0,0,0,0,1,0,0,0,0,1,0,this.x,this.y,this.z,1])}class l{constructor(t){this.x=t.x,this.y=t.y,this.z=t.z}matrix=()=>new o([this.x,0,0,0,0,this.y,0,0,0,0,this.z,0,0,0,0,1])}class u{constructor(t){this.x=t.x,this.y=t.y,this.z=t.z}xMatrix=()=>{const t=this.x,e=Math.cos(t),s=Math.sin(t);return new o([1,0,0,0,0,e,s,0,0,-s,e,0,0,0,0,1])};yMatrix=()=>{const t=this.y,e=Math.cos(t),s=Math.sin(t);return new o([e,0,-s,0,0,1,0,0,s,0,e,0,0,0,0,1])};zMatrix=()=>{const t=this.z,e=Math.cos(t),s=Math.sin(t);return new o([e,s,0,0,-s,e,0,0,0,0,1,0,0,0,0,1])};matrix=()=>this.xMatrix().mul(this.yMatrix()).mul(this.zMatrix())}class d{constructor(t){this.h=t.h,this.s=t.s,this.l=t.l,this.a=t.a}}class f{constructor(t){this.entities=t}}class m{}class g{constructor(t){const e=document.createElement("canvas");e.style.width=t.width.toString(),e.style.height=t.height.toString(),e.style.display="block";const s=e.getContext("webgl2");s.clearColor(0,0,0,1),this.element=e,this.gl=s,this.maxBatchSize=Math.floor(s.getParameter(s.MAX_VERTEX_UNIFORM_VECTORS)/5);const i=`#version 300 es\nuniform mat4[${this.maxBatchSize}] u_matrix;\nuniform vec4[${this.maxBatchSize}] u_color;\n\nin vec4 a_position;\nin uint a_index;\n\nout vec4 v_color;\n\nvoid main() {\n  gl_Position = u_matrix[a_index] * a_position;\n  v_color = u_color[a_index];\n}\n`,n=s.createShader(s.VERTEX_SHADER);s.shaderSource(n,i),s.compileShader(n);const o=s.createShader(s.FRAGMENT_SHADER);s.shaderSource(o,"#version 300 es\nprecision mediump float;\n\nin vec4 v_color;\nout vec4 fragColor;\n\nvec4 hslToRgb(in vec4 hsl) {\n float h = hsl.x / 360.0;\n vec3 rgb = clamp(abs(mod(h * 6.0 + vec3(0.0,4.0,2.0), 6.0) - 3.0) - 1.0, 0.0, 1.0);\n return vec4(hsl.z + hsl.y * (rgb - 0.5) * (1.0 - abs(2.0 * hsl.z - 1.0)), hsl.w);\n}\n\nvoid main() {\n  fragColor = hslToRgb(v_color);\n}\n"),s.compileShader(o);const r=s.createProgram();s.attachShader(r,n),s.attachShader(r,o),s.linkProgram(r),s.getProgramParameter(r,s.LINK_STATUS)||(console.log(s.getShaderInfoLog(n)),console.log(s.getShaderInfoLog(o))),s.useProgram(r),s.enable(s.CULL_FACE),s.enable(s.DEPTH_TEST),this.aPosition={buffer:s.createBuffer(),location:s.getAttribLocation(r,"a_position")},s.enableVertexAttribArray(this.aPosition.location),s.bindBuffer(s.ARRAY_BUFFER,this.aPosition.buffer),s.vertexAttribPointer(this.aPosition.location,3,s.FLOAT,!1,0,0),this.vertexIndexBuffer=s.createBuffer(),this.aIndex={buffer:s.createBuffer(),location:s.getAttribLocation(r,"a_index")},s.enableVertexAttribArray(this.aIndex.location),s.bindBuffer(s.ARRAY_BUFFER,this.aIndex.buffer),s.vertexAttribIPointer(this.aIndex.location,1,s.UNSIGNED_SHORT,0,0),this.uMatrix=s.getUniformLocation(r,"u_matrix"),this.uColor=s.getUniformLocation(r,"u_color"),this.viewport(t)}viewport=({x:t,y:e,width:s,height:i})=>{this.element.width=s,this.element.height=i,this.gl.viewport(t,e,s,i)};renderEntities=function*(t){const e=function*(t){const s=t.entity.get(f);if(s)for(const i of s.entities){const s=i.get(h).matrix().mul(i.get(u).matrix()).mul(i.get(l).matrix()),n={entity:i,transform:t.transform.mul(s)};yield n,yield*e(n)}},s=t.get(a).entity.get(r).matrix;for(const i of t.query(m)){const t=i.get(h).matrix().mul(i.get(u).matrix()).mul(i.get(l).matrix()),n={transform:s.mul(t),entity:i};yield n,yield*e(n)}};render=t=>{performance.now();const e=this.gl;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);t.get(a).entity.get(r).matrix;let s=[],i=[],n=[],o=[],h=[],l=0,u=0;const f=()=>{e.uniformMatrix4fv(this.uMatrix,!1,o),e.uniform4fv(this.uColor,h),e.bindBuffer(e.ARRAY_BUFFER,this.aPosition.buffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(s),e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.vertexIndexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(i),e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,this.aIndex.buffer),e.bufferData(e.ARRAY_BUFFER,new Uint16Array(n),e.STATIC_DRAW),e.drawElements(e.TRIANGLES,i.length,e.UNSIGNED_SHORT,0)};for(const{entity:e,transform:r}of this.renderEntities(t)){const t=e.get(c);if(!t)continue;s.push(...t.vertices);for(const e of t.indices)i.push(e+u);const a=t.vertices.length/3;u+=a,o.push(...r.data);const m=e.get(d);h.push(m.h,m.s,m.l,m.a);for(let t=0;t<a;++t)n.push(l);++l==this.maxBatchSize&&(f(),s=[],i=[],n=[],o=[],h=[],l=0,u=0)}0!=l&&f();performance.now()}}class x{constructor(){this.lookup=new Map,this.data=[],this.inverses=[]}get=t=>{const e=this.lookup.get(t.id);return null!=e?this.data[e]:void 0};hasId=t=>this.lookup.has(t);set=(t,e)=>{const s=this.lookup.get(t.id);if(s)return this.data[s]=e,void(this.inverses[s]=t.id);this.lookup.set(t.id,this.data.length),this.data.push(e),this.inverses.push(t.id)}}class y{constructor(t,e){this.id=t,this.ecs=e,this.set=(...t)=>{for(const e of t){const t=e.constructor;let s=this.ecs.storages.get(t);s||(s=new x,this.ecs.storages.set(t,s)),s.set(this,e)}return this},this.get=t=>{const e=this.ecs.storages.get(t);return e?e.get(this):void 0},this.update=(t,e)=>{const s=this.ecs.storages.get(t);if(!s)return;const i=s.get(this);i&&e(i)}}}const v=new class{constructor(){this.nextEntityId=0,this.storages=new Map,this.resources=new Map}entity=(...t)=>{const e=new y(this.nextEntityId,this);return e.set(...t),++this.nextEntityId,e};query=function*(...t){const e=this.storages.get(t[0]);if(!e)return;const s=t.slice(1).map((t=>this.storages.get(t)));for(const t of e.inverses)s.every((e=>e.hasId(t)))&&(yield new y(t,this))};set=(...t)=>{for(const e of t){const t=e.constructor;this.resources.set(t,e)}};get=t=>this.resources.get(t)};let w={x:0,y:0,width:500,height:500};const _=new n.WebGL2(w);_.element.style.width="100%",_.element.style.height="100%",_.element.style.touchAction="none",document.body.appendChild(_.element);const A=v.entity();v.set(new a(A));const[E,R]=[500,-500],b=()=>{w.width=_.element.clientWidth,w.height=_.element.clientHeight,A.set((({x:t,y:e,width:s,height:i,near:n,far:a})=>{const c=t+s,h=e+i;return new r(new o([2/(c-t),0,0,0,0,2/(e-h),0,0,0,0,2/(n-a),0,(t+c)/(t-c),(h+e)/(h-e),(n+a)/(n-a),1]))})({...w,near:E,far:R})),_.viewport(w)};b(),window.addEventListener("resize",b);const p=(t,e,s)=>v.entity(new c({vertices:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,1,2,3,0,2,2,1,0,2,0,3]}),new h({x:t,y:e,z:0}),new u({x:0,y:0,z:0}),new l({x:10,y:10,z:1}),new d({h:s,s:1,l:.7,a:1}),new m);let M=!1;document.addEventListener("mousedown",(t=>{M=!0,p(t.x,t.y,Math.floor(360*Math.random())),_.render(v)})),document.addEventListener("mouseup",(t=>{M=!1}));let S=0;const F=t=>{requestAnimationFrame(F);for(const e of v.query(u))e.update(u,(e=>e.x+=(t-S)/1e3));S=t,_.render(v)};document.addEventListener("pointermove",(t=>{if(M)for(const e of t.getCoalescedEvents())p(e.x,e.y,Math.floor(360*Math.random()));_.render(v)})),document.addEventListener("touchmove",(t=>{for(const e of t.touches)p(e.clientX,e.clientY,Math.floor(360*Math.random()));_.render(v)})),requestAnimationFrame(F);
//# sourceMappingURL=index.6bddc1a6.js.map
